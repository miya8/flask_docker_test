# 急にネットワークが通じなくなった
今まで問題なかったのに、ある日急に ``docker build``中の``pip install`` で timeout などインターネット不通になった。  
+ 自宅のネットワークは問題なくインターネット接続できている。速度制限も掛けられていない。

### 前提
+ Windows 10 home に Docker ToolBox を使って Dokcer 環境作成していた。  
つまり、以下の構成。

```
                  ---------------------------------
                  | コンテナ1 | コンテナ2 | ・・・ |
                  ------------------------------------
コンテナのホスト   |       デフォルトVM             |  |
                  -------------------------------------
                  |          Virtual Box              |
                  -------------------------------------
仮想マシンのホスト |        Windows 10 Home            |
                  -------------------------------------
```

### 何で解決したか
+ VirtualBox 上の デフォルトVM を再起動で解決した。
    - デフォルトVM のネットワーク障害により、コンテナから外部へのインターネット接続できない状態だった。
    - デフォルトVM がネットワーク障害になった原因やきっかけは不明。

+ 再起動コマンド

```
# デフォルトVMの NAME を確認
$ docker-machine ls
NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER     ERRORS
default   *        virtualbox   Running   tcp://192.168.99.100:2376           v19.03.5

# デフォルトVMを再起動
$ docker-machine restart default
```

# コンテナで公開したページにアクセスできない
Webアプリを作成してコンテナでポート5000で公開した。  
``docker run`` のオプション ``-p 4000:5000`` でポートフォワーディングしたが、  
``http://localhost:4000`` でアクセスできない。  

### 原因
[前提]()に記載した構成を考えれば、  
``-p 4000:5000`` の意味は、  
``コンテナホスト（デフォルトVM）のポート4000にアクセスすると、コンテナの5000ポートに接続するようにする``  
で、
Windows上で ``http://localhost:4000`` とたたく意味は、 ``Windows自身のポート4000にアクセス`` である。  
繋がらないのは当然だった。。。

### 何で解決したか
単に、コンテナホスト（デフォルトVM）のローカルIDを確認し、  
``http://192.168.99.100:4000/``  
とたたいてアクセスできることを確認した。  
  
ちなみに、自分のマシン以外からもアクセスできるようにするには、  
``仮想マシンホストのポートXXにアクセスすると、コンテナホスト（デフォルトVM）のポート4000に接続するようにする``  
ポートフォワーディングの設定をする必要がある。 

# ボリューム設定（docker のデータをWindowsに保存）
+ コンテナ削除するとコンテナ内のデータも一緒に削除されるので、  
永続化したいデータをコンテナ外に保存しておく必要がある。  
  
以下は、コンテナ内の /app/upload_files配下のファイルをWindowsの C:\\・・・\\upload_files 配下に保存

```
docker run --name <コンテナ名> -d -p 3000:5000 -v /c/Users/<ユーザ>/Documents/workspace/study_flask/upload_files:/app/upload_files <イメージ名>
```
